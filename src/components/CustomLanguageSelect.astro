---
/**
 * Custom language selector dropdown.
 * Shows a globe icon + current language label.
 * Clicking opens a styled list; selecting navigates to the same page in the
 * target locale by replacing the leading locale prefix in the URL.
 *
 * Locale-to-path prefix mapping must match astro.config.mjs locales order.
 */

const route = Astro.locals.starlightRoute;
const currentLocale = route.locale ?? 'en';
const currentPath = Astro.url.pathname;

// Keep in sync with astro.config.mjs locales
const locales = [
  { code: 'en',    label: 'English',    shortLabel: 'EN' },
  { code: 'zh-cn', label: '简体中文',   shortLabel: 'ZH' },
  { code: 'zh-hk', label: '繁體中文',   shortLabel: 'HK' },
  { code: 'ja',    label: '日本語',     shortLabel: 'JA' },
];

const currentEntry = locales.find(l => l.code === currentLocale) ?? locales[0];

/**
 * Build the URL for a target locale by replacing the leading /<currentLocale>
 * segment with /<targetCode>.
 */
function buildUrl(targetCode: string): string {
  // e.g. /zh-cn/docs/tos/  →  /zh-hk/docs/tos/
  const re = new RegExp(`^/${currentLocale}(/|$)`);
  const replaced = currentPath.replace(re, `/${targetCode}$1`);
  // If nothing was replaced (e.g. root "/"), navigate to locale index
  return replaced !== currentPath ? replaced : `/${targetCode}/`;
}
---

<div class="lang-select" id="lang-select">
  <!-- Trigger button -->
  <button
    class="lang-btn"
    id="lang-btn"
    aria-haspopup="listbox"
    aria-expanded="false"
    aria-label={`Language: ${currentEntry.label}`}
  >
    <!-- Globe icon -->
    <svg
      class="lang-globe"
      xmlns="http://www.w3.org/2000/svg"
      width="15"
      height="15"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true"
    >
      <circle cx="12" cy="12" r="10"/>
      <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10
               15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
    </svg>
    <span class="lang-label">{currentEntry.label}</span>
    <!-- Chevron -->
    <svg
      class="lang-chevron"
      xmlns="http://www.w3.org/2000/svg"
      width="12"
      height="12"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2.5"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true"
    >
      <polyline points="6 9 12 15 18 9"/>
    </svg>
  </button>

  <!-- Dropdown list -->
  <ul class="lang-dropdown" id="lang-dropdown" role="listbox" aria-label="Select language">
    {locales.map((locale) => (
      <li role="none">
        <a
          href={buildUrl(locale.code)}
          role="option"
          aria-selected={locale.code === currentLocale}
          class:list={['lang-option', { current: locale.code === currentLocale }]}
          lang={locale.code === 'zh-cn' ? 'zh-CN' : locale.code === 'zh-hk' ? 'zh-HK' : locale.code}
        >
          {locale.label}
        </a>
      </li>
    ))}
  </ul>
</div>

<style>
  .lang-select {
    position: relative;
  }

  /* ── Trigger button ─────────────────────────────── */
  .lang-btn {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.3rem 0.6rem;
    border: none;
    border-radius: 0.375rem;
    background: transparent;
    color: var(--sl-color-gray-2);
    font-size: var(--sl-text-sm);
    font-family: inherit;
    cursor: pointer;
    white-space: nowrap;
    transition: color 0.2s ease, background-color 0.2s ease;
  }

  .lang-btn:hover,
  .lang-btn[aria-expanded="true"] {
    color: var(--sl-color-white);
    background-color: hsla(0, 0%, 50%, 0.15);
  }

  .lang-chevron {
    transition: transform 0.2s ease;
    flex-shrink: 0;
  }

  .lang-btn[aria-expanded="true"] .lang-chevron {
    transform: rotate(180deg);
  }

  /* ── Dropdown panel ─────────────────────────────── */
  .lang-dropdown {
    position: absolute;
    top: calc(100% + 0.4rem);
    right: 0;
    min-width: 10rem;
    margin: 0;
    padding: 0.3rem;
    list-style: none;
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-gray-5, hsl(224, 20%, 25%));
    border-radius: 0.5rem;
    box-shadow: 0 8px 24px hsl(0 0% 0% / 0.25);
    z-index: 100;
    /* Hidden by default */
    opacity: 0;
    transform: translateY(-4px);
    pointer-events: none;
    transition: opacity 0.18s ease, transform 0.18s ease;
  }

  .lang-dropdown.open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* ── Options ────────────────────────────────────── */
  .lang-option {
    display: block;
    padding: 0.45rem 0.75rem;
    border-radius: 0.35rem;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-gray-2);
    text-decoration: none;
    transition: background-color 0.15s ease, color 0.15s ease;
  }

  .lang-option:hover {
    background-color: hsla(0, 0%, 50%, 0.12);
    color: var(--sl-color-white);
  }

  .lang-option.current {
    color: var(--sl-color-accent);
    font-weight: 600;
  }

  /* Light-mode adjustments */
  :root[data-theme="light"] .lang-dropdown {
    background: hsl(0, 0%, 100%);
    border-color: hsl(0, 0%, 88%);
    box-shadow: 0 8px 24px hsl(0 0% 0% / 0.10);
  }

  :root[data-theme="light"] .lang-option:hover {
    background-color: hsl(0, 0%, 94%);
    color: hsl(0, 0%, 10%);
  }
</style>

<script>
  (function () {
    const container = document.getElementById('lang-select');
    const btn       = document.getElementById('lang-btn');
    const dropdown  = document.getElementById('lang-dropdown');
    if (!container || !btn || !dropdown) return;

    function open() {
      dropdown.classList.add('open');
      btn!.setAttribute('aria-expanded', 'true');
    }

    function close() {
      dropdown.classList.remove('open');
      btn!.setAttribute('aria-expanded', 'false');
    }

    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdown.classList.contains('open') ? close() : open();
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
      if (!container.contains(e.target as Node)) close();
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });
  })();
</script>

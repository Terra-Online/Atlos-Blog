---
/**
 * Custom Sidebar:
 * - Desktop: TOC (top, fixed height) + current section file navigation (bottom)
 * - Mobile:  Top-level nav links + inline TOC + language selector
 */
import MobileMenuFooter from 'virtual:starlight/components/MobileMenuFooter';
import SidebarPersister from '@astrojs/starlight/components/SidebarPersister.astro';
import SidebarSublist from '@astrojs/starlight/components/SidebarSublist.astro';
import TableOfContents from '@astrojs/starlight/components/TableOfContents.astro';

const route = Astro.locals.starlightRoute;
const { sidebar, toc, locale } = route;
const currentPath = Astro.url.pathname;
const localePrefix = locale ? `/${locale}` : '';

// ── Build top-nav items (all 4 locales) ──
const navT = {
  docs:      { en: 'Docs',      'zh-cn': '文档', 'zh-hk': '文件',   ja: 'ドキュメント' },
  community: { en: 'Community', 'zh-cn': '社区', 'zh-hk': '社群',   ja: 'コミュニティ' },
  blogs:     { en: 'Blogs',     'zh-cn': '博客', 'zh-hk': '部落格', ja: 'ブログ' },
  more:      { en: 'More',      'zh-cn': '更多', 'zh-hk': '更多',   ja: 'その他' },
  onThisPage:{ en: 'On this page', 'zh-cn': '本页目录', 'zh-hk': '本頁目錄', ja: 'このページの目次' },
  language:  { en: 'Language',     'zh-cn': '语言',     'zh-hk': '語言',     ja: '言語' },
} as const;

type LK = keyof typeof navT.docs;
const l = (locale && locale in navT.docs ? locale : 'en') as LK;

const navItems = [
  { label: navT.docs[l],      href: `${localePrefix}/docs/tos/`,                     section: '/docs/' },
  { label: navT.community[l], href: `${localePrefix}/community/about-us/`,           section: '/community/' },
  { label: navT.blogs[l],     href: `${localePrefix}/blogs/reports/sample-report/`, section: '/blogs/' },
  { label: navT.more[l],      href: `${localePrefix}/more/credits/`,                 section: '/more/' },
];

function isActiveSection(section: string): boolean {
  return currentPath.includes(section);
}

// ── Filter sidebar to the current section ──
function hasCurrentEntry(item: any): boolean {
  if (item.isCurrent) return true;
  if (item.entries) return item.entries.some((e: any) => hasCurrentEntry(e));
  return false;
}

const currentGroup = sidebar.filter((item) => hasCurrentEntry(item));
const hasToc = toc && toc.items && toc.items.length > 0;

// ── Flatten nested TOC items for inline mobile list ──
type TocEntry = { text: string; slug: string; depth: number; children?: TocEntry[] };
function flattenToc(items: TocEntry[]): TocEntry[] {
  const out: TocEntry[] = [];
  for (const item of items) {
    out.push(item);
    if (item.children?.length) out.push(...flattenToc(item.children));
  }
  return out;
}
const flatToc = hasToc && toc ? flattenToc(toc.items) : [];
const onThisPage = navT.onThisPage[l];
const langLabel = navT.language[l];

// ── Language options for inline mobile selector ──
const locales = [
  { code: 'en',    label: 'English' },
  { code: 'zh-cn', label: '简体中文' },
  { code: 'zh-hk', label: '繁體中文' },
  { code: 'ja',    label: '日本語' },
];
function buildUrl(targetCode: string): string {
  const currentLocale = locale || 'en';
  const re = new RegExp(`^/${currentLocale}(/|$)`);
  const replaced = currentPath.replace(re, `/${targetCode}$1`);
  return replaced !== currentPath ? replaced : `/${targetCode}/`;
}
---

<!-- ═══════════════  MOBILE  ═══════════════ -->
<div class="mobile-sidebar-content md:sl-hidden">
  <nav class="mobile-nav-links">
    {navItems.map((item) => (
      <a
        href={item.href}
        class:list={['mobile-nav-item', { active: isActiveSection(item.section) }]}
      >
        {item.label}
      </a>
    ))}
  </nav>

  {hasToc && flatToc.length > 0 && (
    <details class="mobile-toc-details">
      <summary class="mobile-toc-summary sl-flex">
        <span>{onThisPage}</span>
        <span class="mobile-toc-caret" aria-hidden="true">▸</span>
      </summary>
      <ul class="mobile-toc-list">
        {flatToc.map((item) => (
          <li class={`toc-depth-${item.depth}`}>
            <a href={`#${item.slug}`}>{item.text}</a>
          </li>
        ))}
      </ul>
    </details>
  )}

  <!-- Language selector row (mobile only) -->
  <div class="mobile-lang-section">
    <span class="mobile-lang-label">{langLabel}</span>
    <div class="mobile-lang-row">
      {locales.map((loc) => (
        <a
          href={buildUrl(loc.code)}
          class:list={['mobile-lang-item', { active: loc.code === (locale || 'en') }]}
          lang={loc.code === 'zh-cn' ? 'zh-CN' : loc.code === 'zh-hk' ? 'zh-HK' : loc.code}
        >
          {loc.label}
        </a>
      ))}
    </div>
  </div>
</div>

<!-- ═══════════════  DESKTOP  ═══════════════ -->
<div class="desktop-sidebar-content sl-hidden md:sl-flex">
  {hasToc && (
    <div class="sidebar-toc-panel">
      <TableOfContents />
    </div>
  )}

  <div class="sidebar-section-nav">
    <SidebarPersister>
      <SidebarSublist sublist={currentGroup} />
    </SidebarPersister>
  </div>
</div>

<div class="md:sl-hidden">
  <MobileMenuFooter />
</div>

<style>
  /* ─── Mobile Nav Links ─── */
  .mobile-nav-links {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--sl-color-gray-6);
  }

  .mobile-nav-item {
    display: flex;
    align-items: center;
    padding: 0.625rem 1rem;
    font-size: var(--sl-text-base);
    font-weight: 500;
    color: var(--sl-color-gray-2);
    text-decoration: none;
    border-radius: 0.375rem;
    transition: color 0.2s ease, background-color 0.2s ease;
  }

  .mobile-nav-item:hover {
    color: var(--sl-color-white);
    background-color: var(--sl-color-gray-6);
  }

  .mobile-nav-item.active {
    color: var(--sl-color-accent);
    background-color: hsla(27, 91%, 54%, 0.08);
  }

  /* ─── Mobile Inline TOC (replaces fixed-position MobileTableOfContents) ─── */
  .mobile-toc-details {
    border-top: 1px solid var(--sl-color-gray-6);
    margin: 0;
  }

  .mobile-toc-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    list-style: none;
    padding: 0.625rem 1rem;
    font-size: var(--sl-text-sm);
    font-weight: 600;
    color: var(--sl-color-gray-3);
    cursor: pointer;
    user-select: none;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: color 0.2s ease;
  }
  .mobile-toc-summary::-webkit-details-marker,
  .mobile-toc-summary::marker { display: none; }
  .mobile-toc-summary:hover { color: var(--sl-color-white); }
  .mobile-toc-details[open] .mobile-toc-summary { color: var(--sl-color-accent); }

  .mobile-toc-caret {
    font-size: 0.75rem;
    transition: transform 0.2s ease;
  }
  .mobile-toc-details[open] .mobile-toc-caret { transform: rotate(90deg); }

  .mobile-toc-list {
    list-style: none;
    margin: 0;
    padding: 0.25rem 0 0.75rem;
  }

  .mobile-toc-list a {
    display: block;
    padding: 0.3rem 1rem;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-gray-3);
    text-decoration: none;
    transition: color 0.2s ease;
    overflow-wrap: anywhere;
  }
  .mobile-toc-list a:hover { color: var(--sl-color-white); }

  /* Depth indentation */
  .toc-depth-2 a { padding-inline-start: 1rem; }
  .toc-depth-3 a { padding-inline-start: 1.75rem; }
  .toc-depth-4 a { padding-inline-start: 2.5rem; }

  /* ─── Desktop Sidebar ─── */
  .desktop-sidebar-content {
    flex-direction: column;
    height: 100%;
    gap: 0;
  }

  /* TOC panel (fixed height, scrollable) */
  .sidebar-toc-panel {
    max-height: 40vh;
    overflow-y: auto;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--sl-color-gray-6);
    margin-bottom: 0.75rem;
    scrollbar-width: thin;
  }

  .sidebar-toc-heading {
    color: var(--sl-color-white);
    font-size: var(--sl-text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  .sidebar-toc-panel :global(a) {
    display: block;
    font-size: var(--sl-text-xs);
    text-decoration: none;
    color: var(--sl-color-gray-3);
    overflow-wrap: anywhere;
    padding: 0.2rem 0;
    transition: color 0.2s ease;
  }

  .sidebar-toc-panel :global(a:hover) {
    color: var(--sl-color-white);
  }

  .sidebar-toc-panel :global(a[aria-current='true']) {
    color: var(--sl-color-text-accent);
  }

  /* Section nav (fills remaining space) */
  .sidebar-section-nav {
    flex: 1;
    overflow-y: auto;
    scrollbar-width: thin;
  }

  /* Mobile language selector */
  .mobile-lang-section {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--sl-color-gray-5);
  }

  .mobile-lang-label {
    display: block;
    font-size: var(--sl-text-xs);
    font-weight: 600;
    color: var(--sl-color-white);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .mobile-lang-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .mobile-lang-item {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: var(--sl-text-sm);
    text-decoration: none;
    color: var(--sl-color-gray-2);
    background: var(--sl-color-gray-6);
    transition: background 0.2s ease, color 0.2s ease;
  }

  .mobile-lang-item:hover {
    background: var(--sl-color-gray-5);
    color: var(--sl-color-white);
  }

  .mobile-lang-item.active {
    background: var(--sl-color-text-accent);
    color: var(--sl-color-black);
    font-weight: 600;
    pointer-events: none;
  }

  @media (min-width: 50rem) {
    .mobile-lang-section {
      display: none;
    }
  }
</style>

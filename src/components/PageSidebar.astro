---
/**
 * Custom Right Sidebar — Document metadata:
 * 1. Last Updated (build timestamp → user's local timezone)
 * 2. Time Ago (relative time)
 * 3. Authors (GitHub contributors)
 *
 * On mobile the MobileTableOfContents is suppressed because
 * our custom Sidebar already includes the TOC.
 */

const route = Astro.locals.starlightRoute;
const { lastUpdated, locale, entry } = route;
const isZhCn = locale === 'zh-cn';

// Use frontmatter lastUpdated, route lastUpdated, or current build time
const updateDate: Date = lastUpdated ?? new Date();
const isoTimestamp = updateDate.toISOString();

// Attempt to get git authors at build time
let authors: string[] = [];
try {
  const { execSync } = await import('node:child_process');
  const entryId = entry.id;
  const filePath = `src/content/docs/${entryId}`;
  const result = execSync(`git log --format='%aN' -- "${filePath}" 2>/dev/null | sort -u`, {
    encoding: 'utf-8',
    timeout: 5000,
  }).trim();
  if (result) {
    authors = result.split('\n').filter(Boolean);
  }
} catch {
  // git not available or file not tracked — use fallback
}
if (authors.length === 0) {
  authors = ['Open Endfield Map Team'];
}
---

<div class="right-sidebar-panel sl-hidden lg:sl-block">
  <div class="sl-container meta-panel">
    <h2 class="meta-heading">{isZhCn ? '文档信息' : 'Document Info'}</h2>

    <!-- Last Updated -->
    <div class="meta-item">
      <div class="meta-label">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        {isZhCn ? '上次更新' : 'Last Updated'}
      </div>
      <time class="meta-value" id="meta-last-updated" datetime={isoTimestamp}>
        {updateDate.toLocaleDateString(isZhCn ? 'zh-CN' : 'en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        })}
      </time>
    </div>

    <!-- Time Ago -->
    <div class="meta-item">
      <div class="meta-label">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
        {isZhCn ? '距今' : 'Time Ago'}
      </div>
      <span class="meta-value" id="meta-time-ago" data-timestamp={isoTimestamp}>—</span>
    </div>

    <!-- Authors -->
    <div class="meta-item">
      <div class="meta-label">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        {isZhCn ? '作者' : 'Authors'}
      </div>
      <div class="meta-authors">
        {authors.map((author) => (
          <a
            class="author-chip"
            href={`https://github.com/${author}`}
            target="_blank"
            rel="noopener noreferrer"
          >
            <img
              src={`https://github.com/${author}.png?size=24`}
              alt={author}
              width="18"
              height="18"
              class="author-avatar"
              loading="lazy"
              onerror="this.style.display='none'"
            />
            {author}
          </a>
        ))}
      </div>
    </div>
  </div>
</div>

<script>
  function updateMetaTimeAgo() {
    const el = document.getElementById('meta-time-ago');
    if (!el) return;
    const ts = el.dataset.timestamp;
    if (!ts) return;

    const diff = Date.now() - new Date(ts).getTime();
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    const months = Math.floor(days / 30);
    const years = Math.floor(days / 365);

    const zh = document.documentElement.lang === 'zh-CN';
    let text: string;
    if (years > 0) text = zh ? `${years} 年前` : `${years} year${years > 1 ? 's' : ''} ago`;
    else if (months > 0) text = zh ? `${months} 个月前` : `${months} month${months > 1 ? 's' : ''} ago`;
    else if (days > 0) text = zh ? `${days} 天前` : `${days} day${days > 1 ? 's' : ''} ago`;
    else if (hours > 0) text = zh ? `${hours} 小时前` : `${hours} hour${hours > 1 ? 's' : ''} ago`;
    else if (minutes > 0) text = zh ? `${minutes} 分钟前` : `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    else text = zh ? '刚刚' : 'just now';

    el.textContent = text;
  }

  function updateMetaLastUpdated() {
    const el = document.getElementById('meta-last-updated');
    if (!el) return;
    const dt = el.getAttribute('datetime');
    if (!dt) return;
    const zh = document.documentElement.lang === 'zh-CN';
    el.textContent = new Date(dt).toLocaleDateString(zh ? 'zh-CN' : 'en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  }

  updateMetaLastUpdated();
  updateMetaTimeAgo();
  setInterval(updateMetaTimeAgo, 60_000);
</script>

<style>
  .right-sidebar-panel {
    padding: 1rem var(--sl-sidebar-pad-x);
  }

  .sl-container {
    width: calc(var(--sl-sidebar-width) - 2 * var(--sl-sidebar-pad-x));
  }

  @media (min-width: 72rem) {
    .sl-container {
      max-width: calc(
        (100vw - var(--sl-sidebar-width) - 2 * var(--sl-content-pad-x) - 2 * var(--sl-sidebar-pad-x)) * 0.25
      );
    }
  }

  /* ─── Meta Panel ─── */
  .meta-heading {
    color: var(--sl-color-white);
    font-size: var(--sl-text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
  }

  .meta-item {
    margin-bottom: 1rem;
  }

  .meta-label {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: var(--sl-text-xs);
    font-weight: 500;
    color: var(--sl-color-gray-3);
    margin-bottom: 0.25rem;
  }

  .meta-label svg {
    flex-shrink: 0;
    opacity: 0.7;
  }

  .meta-value {
    display: block;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-gray-1);
    padding-left: 1.375rem;
  }

  /* ─── Authors ─── */
  .meta-authors {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    padding-left: 1.375rem;
  }

  .author-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.5rem;
    font-size: var(--sl-text-xs);
    color: var(--sl-color-gray-2);
    background: var(--sl-color-gray-6);
    border-radius: 999px;
    text-decoration: none;
    transition: color 0.2s ease, background-color 0.2s ease;
  }

  .author-chip:hover {
    color: var(--sl-color-white);
    background: var(--sl-color-gray-5);
  }

  .author-avatar {
    border-radius: 50%;
    vertical-align: middle;
  }
</style>

---
/**
 * RightBar.astro — Right sidebar: document metadata.
 *
 * Last-updated: Starlight reads git log automatically when
 *   `lastUpdated: true` is set in astro.config.mjs and the file
 *   frontmatter has no `lastUpdated` field — result exposed as
 *   `route.lastUpdated` (a proper Date in UTC, no timezone skew).
 *
 * Authors: execSync runs once per page during SSG build.
 *   Remark-plugin frontmatter injection cannot write into
 *   entry.data in Astro v5's Content Layer, so we run git here.
 *
 * Icons: astro-icon + @iconify-json/lucide
 */
import { execSync }  from 'node:child_process';
import { join }      from 'node:path';
import { existsSync } from 'node:fs';
import { Icon }      from 'astro-icon/components';

const route = Astro.locals.starlightRoute;
const { locale, entry } = route;
const isZh = locale === 'zh-cn';

// ── Last-updated timestamp ─────────────────────────────────────────────
// route.lastUpdated is populated by Starlight's git integration.
// Fallback to build-time Date for uncommitted files.
const updateDate: Date = route.lastUpdated ?? new Date();
const isoTimestamp = updateDate.toISOString();

// ── Authors — direct git log at SSG build time ─────────────────────────
// entry.id = locale-relative path WITHOUT extension in Astro v5 glob loader,
// e.g. "en/docs/tos". Resolve the actual file by trying known extensions.
const authors: string[] = (() => {
  try {
    const base = join(process.cwd(), 'src/content/docs', entry.id);
    const filePath =
      [base, `${base}.md`, `${base}.mdx`].find(existsSync) ?? base;
    const raw = execSync(
      `git log --format="%aN" -- "${filePath}"`,
      { encoding: 'utf-8', timeout: 5000, stdio: ['pipe', 'pipe', 'pipe'] },
    ).trim();
    if (!raw) return ['Open Endfield Map Team'];
    const seen = new Set<string>();
    const unique: string[] = [];
    for (const name of raw.split('\n').map((n) => n.trim()).filter(Boolean)) {
      if (!seen.has(name)) { seen.add(name); unique.push(name); }
    }
    return unique.length > 0 ? unique : ['Open Endfield Map Team'];
  } catch {
    return ['Open Endfield Map Team'];
  }
})();

// Detect GitHub-style handle (no spaces, not the fallback string)
const isHandle = (s: string) =>
  !s.includes(' ') && s !== 'Open Endfield Map Team';
---

<div class="right-sidebar-panel sl-hidden lg:sl-block">
  <div class="sl-container meta-panel">

    <h2 class="meta-heading">
      <Icon name="lucide:file-text" class="icon-sm" aria-hidden="true" />
      {isZh ? '文档信息' : 'Document Info'}
    </h2>

    <!-- Last Updated -->
    <div class="meta-item">
      <p class="meta-label">
        <Icon name="lucide:clock" class="icon-xs" aria-hidden="true" />
        {isZh ? '上次更新' : 'Last Updated'}
      </p>
      <time class="meta-value" id="rightbar-updated" datetime={isoTimestamp}>
        {updateDate.toLocaleDateString(isZh ? 'zh-CN' : 'en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        })}
      </time>
    </div>

    <!-- Time Ago -->
    <div class="meta-item">
      <p class="meta-label">
        <Icon name="lucide:history" class="icon-xs" aria-hidden="true" />
        {isZh ? '距今' : 'Time Ago'}
      </p>
      <span class="meta-value" id="rightbar-ago" data-ts={isoTimestamp}>—</span>
    </div>

    <!-- Authors -->
    <div class="meta-item">
      <p class="meta-label">
        <Icon name="lucide:users" class="icon-xs" aria-hidden="true" />
        {isZh ? '作者' : 'Authors'}
      </p>
      <div class="meta-authors">
        {authors.map((name) =>
          isHandle(name) ? (
            <a
              class="author-chip"
              href={`https://github.com/${name}`}
              target="_blank"
              rel="noopener noreferrer"
            >
              <img
                src={`https://github.com/${name}.png?size=24`}
                alt={name}
                width="16"
                height="16"
                class="author-avatar"
                loading="lazy"
                onerror="this.style.display='none'"
              />
              {name}
            </a>
          ) : (
            <span class="author-chip author-chip--plain">
              <Icon name="lucide:user" class="icon-xs" aria-hidden="true" />
              {name}
            </span>
          )
        )}
      </div>
    </div>

  </div>
</div>

<script>
  const M = 60_000, H = 60*M, D = 24*H, MO = 30*D, Y = 365*D;
  const zh = () => document.documentElement.lang.toLowerCase().startsWith('zh');

  function ago(ms: number): string {
    const z = zh();
    if (ms < M)  return z ? '刚刚' : 'just now';
    if (ms < H)  { const n=Math.floor(ms/M);  return z?`${n} 分钟前`:`${n} min${n>1?'s':''} ago`; }
    if (ms < D)  { const n=Math.floor(ms/H);  return z?`${n} 小时前`:`${n} hr${n>1?'s':''} ago`; }
    if (ms < MO) { const n=Math.floor(ms/D);  return z?`${n} 天前`:`${n} day${n>1?'s':''} ago`; }
    if (ms < Y)  { const n=Math.floor(ms/MO); return z?`${n} 个月前`:`${n} mo${n>1?'s':''} ago`; }
    const n=Math.floor(ms/Y); return z?`${n} 年前`:`${n} yr${n>1?'s':''} ago`;
  }

  function tick() {
    const el = document.getElementById('rightbar-ago');
    const ts = el?.dataset.ts;
    if (el && ts) el.textContent = ago(Date.now() - +new Date(ts));
  }

  function locDate() {
    const el = document.getElementById('rightbar-updated') as HTMLTimeElement | null;
    const dt = el?.getAttribute('datetime');
    if (el && dt) {
      el.textContent = new Date(dt).toLocaleDateString(
        zh() ? 'zh-CN' : 'en-US',
        { year: 'numeric', month: 'long', day: 'numeric' }
      );
    }
  }

  locDate();
  tick();
  setInterval(tick, 60_000);
</script>

<style>
  .right-sidebar-panel {
    padding: 1rem var(--sl-sidebar-pad-x);
  }
  .sl-container {
    width: calc(var(--sl-sidebar-width) - 2 * var(--sl-sidebar-pad-x));
  }
  @media (min-width: 72rem) {
    .sl-container {
      max-width: calc(
        (100vw - var(--sl-sidebar-width) - 2 * var(--sl-content-pad-x) -
          2 * var(--sl-sidebar-pad-x)) * 0.25
      );
    }
  }

  /* heading */
  .meta-heading {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    color: var(--sl-color-white);
    font-size: var(--sl-text-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
  }

  /* rows */
  .meta-item {
    margin-bottom: 1rem;
  }
  .meta-label {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    font-size: var(--sl-text-xs);
    font-weight: 500;
    color: var(--sl-color-gray-3);
    margin: 0 0 0.3rem;
  }
  .meta-value {
    display: block;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-gray-1);
    padding-left: 1.25rem;
  }

  /* authors */
  .meta-authors {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    padding-left: 1.25rem;
  }
  .author-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.2rem 0.55rem;
    font-size: var(--sl-text-xs);
    color: var(--sl-color-gray-2);
    background: var(--sl-color-gray-6);
    border-radius: 999px;
    text-decoration: none;
    width: fit-content;
    transition: color 0.2s ease, background-color 0.2s ease;
  }
  .author-chip:hover,
  a.author-chip:hover {
    color: var(--sl-color-white);
    background: var(--sl-color-gray-5);
  }
  .author-chip--plain {
    cursor: default;
  }
  .author-avatar {
    border-radius: 50%;
    object-fit: cover;
  }

  /* icon sizing helpers */
  .icon-sm {
    width: 0.875rem;
    height: 0.875rem;
    opacity: 0.7;
    flex-shrink: 0;
  }
  .icon-xs {
    width: 0.8rem;
    height: 0.8rem;
    opacity: 0.7;
    flex-shrink: 0;
  }
</style>
